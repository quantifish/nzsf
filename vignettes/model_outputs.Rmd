---
title: "New Zealand Spatial Features: Model Outputs"
author: Darcy Webber
date: 19 March 2022
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{New Zealand Spatial Features: Model Outputs}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r echo=TRUE}
# library(tidyverse)
library(ggplot2)
library(dplyr)
library(nzsf)
library(viridis)
library(brms)
library(reshape2)

theme_set(theme_bw())
```

# Plotting splines in brms

```{r echo=TRUE, fig.height=6, fig.width=12, message=FALSE}
# Use Stewart Island as the land
stewart <- nzsf::nz_coastlines_and_islands_polygons_topo_1500k %>%
  filter(name == "Stewart Island/Rakiura") %>%
  st_transform(crs = proj_nzsf()) %>%
  st_buffer(dist = 45000)

# Use the volcano data set to come up with some values
data(volcano)
colnames(volcano) <- seq(st_bbox(stewart)[2], st_bbox(stewart)[4], length.out = ncol(volcano))
rownames(volcano) <- seq(st_bbox(stewart)[1], st_bbox(stewart)[3], length.out = nrow(volcano))
v0 <- volcano %>% 
  melt(varnames = c("x", "y"), value.name = "z") %>%
  st_as_sf(coords = c("x", "y"), crs = proj_nzsf()) %>%
  mutate(x = st_coordinates(.)[,1], y = st_coordinates(.)[,2])
v <- v0 %>%
  sample_n(size = 1000)
head(v)

# Plot the points
ggplot() +
  geom_sf(data = v, aes(colour = z)) +
  scale_colour_viridis(alpha = 0.8) +
  plot_coast(resolution = "medium", fill = "black", colour = NA, size = 0.3) +
  plot_clip(x = stewart) +
  labs(colour = "Points", title = "Rakiura")
```

Fit a model to the data and use the brms conditional_smooths function to look at it

```{r echo=TRUE, fig.height=6, fig.width=12, message=FALSE}
fit <- brm(z ~ t2(x, y), data = v, chains = 1, iter = 1000)

conditional_smooths(x = fit, resolution = 100, smooths = "t2(x, y)")
```

```{r echo=TRUE, fig.height=6, fig.width=12, message=FALSE}
ggplot() +
  plot_raster(data = v0, field = "z", fun = mean, nrow = 50, ncol = 80) +
  scale_fill_viridis("volcano", alpha = 0.8, option = "plasma") +
  plot_coast(resolution = "medium", fill = "black", colour = NA, size = 0.3) +
  plot_clip(x = stewart) +
  theme(axis.title = element_blank())
```

```{r echo=TRUE, fig.height=6, fig.width=12, message=FALSE}
ggplot() +
  plot_conditional_smooths(x = fit, resolution = 100, smooths = "t2(x, y)", crs1 = proj_nzsf(), crs2 = proj_nzsf()) +
  scale_fill_viridis("t2(x, y)", alpha = 0.8, option = "plasma") +
  plot_coast(resolution = "medium", fill = "black", colour = NA, size = 0.3) +
  plot_clip(x = stewart) +
  theme(axis.title = element_blank())
```
