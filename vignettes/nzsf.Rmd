---
title: "New Zealand Spatial Features"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{New Zealand Spatial Features}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `nzsf` package relies heavily on the R packages `ggplot2`, `dplyr`, and `sf`. Maps can be built up in layers in the same way as `ggplot2`. A basic map of the New Zealand coastline with a north arrow and a scale bar can be built using the `nzsf` helper function `plot_coast` and functions from the `ggspatial` package:

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
library(nzsf)
library(ggspatial)

theme_set(theme_bw() + theme(axis.title = element_blank()))

ggplot() +
  plot_statistical_areas(area = "EEZ") +
  plot_coast(resolution = "low", fill = "black", colour = "black", size = 0.3) +
  annotation_north_arrow(location = "tl", which_north = "true", style = north_arrow_nautical) +
  annotation_scale(location = "br", unit_category = "metric")
```

```{r echo=TRUE, fig.height=6, fig.width=10, message=FALSE}
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)

world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  st_transform(3994)

CCSBT3994 <- CCSBT %>% 
  st_transform(3994) %>%
  st_union(by_feature = TRUE)
ccsbt_lab <- st_centroid(CCSBT3994)
ccsbt_bb <- CCSBT3994 %>% st_buffer(dist = 1e5) %>% st_bbox()

# Simulate some points within the areas
pts1 <- st_sample(CCSBT3994, size = 100) %>% st_sf() %>% mutate(z = rnorm(1:n()))
pts2 <- st_sample(CCSBT3994, size = 5000) %>% st_sf() %>% mutate(z = rnorm(1:n()))

# Sum up points within voronoi polygons
vri <- pts1 %>%
  st_union() %>%
  st_voronoi() %>%
  st_collection_extract() %>%
  st_cast() %>%
  st_sf() %>%
  mutate(id = 1:n()) %>%
  st_join(pts2, join = st_contains, left = TRUE) %>%
  group_by(id) %>%
  summarise(z = sum(z)) %>%
  st_intersection(CCSBT3994)

ggplot() +
  geom_sf(data = vri, aes(fill = z), colour = NA) +
  scale_fill_viridis("Variable", alpha = 0.7, na.value = NA) +
  geom_sf(data = world, fill = "black", colour = "black") +
  geom_sf(data = CCSBT3994, fill = NA, colour = "red") +
  geom_sf_label(data = ccsbt_lab, aes(label = Area)) +
  coord_sf(xlim = ccsbt_bb[c(1, 3)], ylim = ccsbt_bb[c(2, 4)], expand = FALSE)
```

Layers such as New Zealand marine reserves, depth countours, and Quota Management Areas (QMAs) can be added easily with several of the `nzsf` helper functions including `plot_marine_reserves`, `plot_depth`, and `plot_qma`. Maps can be retricted (e.g. to the North Island only) using a bounding box generated using `st_bbox` from the `sf` package:

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
bbox <- get_coast() %>% 
  filter(name %in% c("North Island or Te Ika-a-MÄui")) %>%
  st_bbox()

ggplot() +
  plot_depth(colour = "lightblue") +
  plot_marine_reserves(fill = "red", colour = "red") +
  plot_qma(qma = "CRA", fill = NA) +
  plot_coast(fill = "grey", colour = NA, size = 0.3) +
  annotation_north_arrow(location = "tr", style = north_arrow_nautical) +
  # annotation_north_arrow(location = "tr", which_north = "true", style = north_arrow_nautical) +
  # annotation_scale(location = "br", unit_category = "metric") +
  coord_sf(xlim = bbox[c(1, 3)], ylim = bbox[c(2, 4)])
```

Adding labels can be a little tricky but can be done with:

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
library(lwgeom)

sf_jma <- get_qma("JMA")
sf_coast <- get_coast() %>% 
  st_combine() %>% 
  st_make_valid()
lab <- st_difference(sf_jma, sf_coast) %>% 
  st_point_on_surface()
# lab <- st_difference(sf_jma, sf_coast) %>% st_centroid()

ggplot() +
  plot_qma(qma = "JMA", fill = NA) +
  plot_statistical_areas(area = "JMA", fill = NA) +
  plot_coast(fill = "forestgreen", colour = NA, size = 0.3) +
  geom_sf_label(data = lab, aes(label = QMA)) +
  annotation_north_arrow(location = "tl", which_north = "true") +
  annotation_scale(location = "br", unit_category = "metric")
```

You can then add polygons, points, lines/arrows, and/or rasters to maps and change the map projection:

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
proj <- "+proj=longlat +datum=WGS84 +no_defs"

data("Gisborne_TToR_Habitats")
Gisborne_TToR_Habitats <- Gisborne_TToR_Habitats %>% st_transform(crs = proj, check = TRUE)

data("Rocky_reef_National_NZ")
Rocky_reef_National_NZ <- Rocky_reef_National_NZ %>% st_transform(crs = proj, check = TRUE)

bbox <- get_marine_reserves() %>%
  st_transform(crs = proj, check = TRUE) %>%
  filter(Name == "Te Tapuwae o Rongokako Marine Reserve") %>%
  st_bbox()

ggplot() +
  geom_sf(data = Rocky_reef_National_NZ, fill = "lightgrey", colour = NA) +
  plot_depth(proj = proj, resolution = "med", size = 0.2, colour = "skyblue") +
  geom_sf(data = Gisborne_TToR_Habitats, aes(fill = Habitat), colour = NA) +
  scale_fill_viridis_d(alpha = 0.5) +
  plot_marine_reserves(proj = proj, fill = NA) +
  plot_coast(proj = proj, resolution = "med", fill = "black", colour = NA, size = 0.3) +
  # annotation_scale(location = "br", unit_category = "metric") +
  coord_sf(xlim = bbox[c(1, 3)], ylim = bbox[c(2, 4)]) +
  labs(title = "Te Tapuwae o Rongokako Marine Reserve")
```


```{r echo=TRUE, fig.height=6, fig.width=12, message=FALSE}
library(patchwork)

stewart <- get_coast() %>%
  filter(name == "Stewart Island/Rakiura") %>%
  st_buffer(dist = 4500)
bbox <- stewart %>% st_bbox()

# Simulate some points around Stewart Island
pts <- st_sample(stewart, size = 5000) %>% st_sf() %>% mutate(z = rnorm(1:n()))

p1 <- ggplot() +
  plot_depth(resolution = "med", size = 0.2, colour = "grey") +
  geom_sf(data = pts, aes(colour = z)) +
  plot_coast(resolution = "med", fill = "black", colour = NA, size = 0.3) +
  annotation_north_arrow(location = "tl", style = north_arrow_nautical) +
  # annotation_north_arrow(location = "tl", which_north = "true", style = north_arrow_nautical) +
  # annotation_scale(location = "br", unit_category = "metric") +
  coord_sf(xlim = bbox[c(1, 3)], ylim = bbox[c(2, 4)]) +
  labs(colour = "Points", title = "Rakiura")
p2 <- ggplot() +
  plot_depth(resolution = "med", size = 0.2, colour = "grey") +
  plot_raster(data = pts, field = "z", fun = mean, nrow = 50, ncol = 50) +
  scale_fill_viridis("Raster", alpha = 0.8, option = "plasma") +
  plot_coast(resolution = "med", fill = "black", colour = NA, size = 0.3) +
  annotation_north_arrow(location = "tl", style = north_arrow_nautical) +
  # annotation_north_arrow(location = "tl", which_north = "true", style = north_arrow_nautical) +
  # annotation_scale(location = "br", unit_category = "metric") +
  coord_sf(xlim = bbox[c(1, 3)], ylim = bbox[c(2, 4)]) +
  labs(title = "Rakiura")
p1 + p2
```

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
data(mfe_average_sst)

rpts <- mfe_average_sst %>%
  rasterToPoints() %>%
  data.frame()

ggplot() +
  geom_raster(data = rpts, aes(x = x, y = y, fill = layer)) +
  plot_statistical_areas(area = "EEZ", fill = NA) +
  plot_coast(resolution = "med", fill = "black", colour = NA, size = 0.3) +
  coord_sf() +
  scale_fill_viridis(alpha = 0.8, option = "magma") +
  labs(fill = "Depth (m)")
```

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
# data(gebco_depth_raster)
# 
# rpts <- gebco_depth_raster %>%
#   rasterToPoints() %>%
#   data.frame()
# 
# ggplot() +
#   geom_raster(data = rpts, aes(x = x, y = y, fill = layer)) +
#   plot_statistical_areas(area = "EEZ", fill = NA) +
#   plot_coast(resolution = "med", fill = "black", colour = NA, size = 0.3) +
#   coord_sf() +
#   scale_fill_viridis(alpha = 0.8, option = "magma") +
#   labs(fill = "Depth (m)")
```

```{r echo=TRUE, fig.height=6, fig.width=6, message=FALSE}
# Add ERA5 data here
# wf_set_key(user = "youremail@gmail.com", key = "secretkey", service = "webapi")
```